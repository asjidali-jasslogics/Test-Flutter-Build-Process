name: ğŸ§± Flutter Build Automation

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GH_USERNAME: ${{ secrets.USERNAME }}
      GH_REPO: ${{ secrets.REPO }}
      GH_TOKEN: ${{ secrets.GH_PAT }}
      BRANCH: main

    steps:
      - name: ğŸ§¹ Checkout triggering repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "Updating and installing dependencies..."
          sudo apt update -y
          sudo apt install -y unzip zip git curl wget openjdk-17-jdk

      - name: ğŸª„ Install Flutter SDK
        run: |
          echo "Installing Flutter SDK..."
          git clone https://github.com/flutter/flutter.git -b stable /opt/flutter
          export PATH="/opt/flutter/bin:/opt/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter doctor -v
          flutter --version

      - name: ğŸ” Clone private Flutter repository
        run: |
          echo "Cloning private Flutter repository..."
          git clone -b $BRANCH https://$GH_USERNAME:$GH_TOKEN@github.com/$GH_USERNAME/$GH_REPO.git app
          cd app
          export PATH="/opt/flutter/bin:/opt/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter pub get

      - name: ğŸ§° Patch Gradle and AGP Versions (Auto-fix)
        run: |
          echo "Patching Gradle and Android Gradle Plugin versions..."
          cd app/android

          # Safely patch AGP version (8.1.1+)
          if grep -q "com.android.tools.build:gradle" build.gradle; then
            sed -i "s#com\.android\.tools\.build:gradle:[0-9\.]\+#com.android.tools.build:gradle:8.1.1#g" build.gradle || true
          fi

          # Safely update Gradle wrapper to 8.7
          if [ -f gradle/wrapper/gradle-wrapper.properties ]; then
            echo "Updating Gradle wrapper to 8.7..."
            sed -i "s#distributionUrl=.*#distributionUrl=https\\://services.gradle.org/distributions/gradle-8.7-bin.zip#g" gradle/wrapper/gradle-wrapper.properties || true
          fi

          echo "ğŸ”§ Gradle configuration after patch:"
          grep "com.android.tools.build:gradle" build.gradle || echo "AGP line verified"
          grep "distributionUrl" gradle/wrapper/gradle-wrapper.properties || echo "Gradle wrapper verified"

      - name: ğŸš€ Build Flutter APK (skip dependency validation)
        run: |
          echo "Building Flutter release APK..."
          cd app
          export PATH="/opt/flutter/bin:/opt/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter build apk --release --android-skip-build-dependency-validation

      - name: ğŸ“¦ Package build artifacts
        run: |
          echo "Packaging release build..."
          cd app/build/app/outputs/flutter-apk
          zip -r flutter_build_${{ github.run_id }}.zip .
          mv flutter_build_${{ github.run_id }}.zip $GITHUB_WORKSPACE/
          echo "âœ… Build packaged successfully."

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter_build_${{ github.run_id }}
          path: flutter_build_${{ github.run_id }}.zip
          retention-days: 5
