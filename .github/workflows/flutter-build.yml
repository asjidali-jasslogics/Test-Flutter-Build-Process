name: 🧱 Flutter Build Automation (Dev Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GH_USERNAME: ${{ secrets.USERNAME }}
      GH_REPO: ${{ secrets.REPO }}
      GH_TOKEN: ${{ secrets.GH_PAT }}
      BRANCH: main
      ANDROID_HOME: ${{ github.workspace }}/android-sdk

    steps:
      - name: 🧹 Checkout triggering repository
        uses: actions/checkout@v4

      - name: 📦 Install dependencies
        run: |
          echo "Updating and installing dependencies..."
          sudo apt update -y
          sudo apt install -y unzip zip git curl wget openjdk-17-jdk libgtk-3-dev

      - name: 🪄 Install Flutter 3.24.2
        run: |
          echo "Installing Flutter SDK (3.24.2)..."
          git clone https://github.com/flutter/flutter.git -b 3.24.2 /opt/flutter
          echo "/opt/flutter/bin" >> $GITHUB_PATH
          echo "/opt/flutter/bin/cache/dart-sdk/bin" >> $GITHUB_PATH
          flutter doctor -v
          flutter --version

      - name: 🔐 Clone private Flutter repository
        run: |
          echo "Cloning private Flutter repository..."
          git clone -b $BRANCH https://$GH_USERNAME:$GH_TOKEN@github.com/$GH_USERNAME/$GH_REPO.git app
          cd app
          flutter pub get

      - name: 🔧 Fix Custom Gradle Tasks (Linux Compatible)
        run: |
          echo "Fixing custom Gradle tasks for Linux environment..."
          cd app/android/app
          
          # Check if the problematic task exists in build.gradle
          if grep -q "updateAppName" build.gradle; then
            echo "Found updateAppName task, creating Linux-compatible version..."
            
            # Create a Linux-compatible script to replace the Windows cmd commands
            mkdir -p scripts
            cat > scripts/update_app_name.sh << 'EOF'
              #!/bin/bash
              echo "Linux-compatible app name update script"
              # Add your Linux-compatible logic here instead of Windows cmd commands
              # For example, use sed to modify files instead of Windows-specific commands
            EOF
            chmod +x scripts/update_app_name.sh
            
            # Replace the Windows task with Linux-compatible version
            sed -i 's/commandLine "cmd",.*/commandLine "bash", "scripts\/update_app_name.sh"/g' build.gradle
          fi

      - name: 🧰 Patch Gradle, AGP, and SDK versions
        run: |
          echo "Patching Android configuration..."
          cd app/android

          # Update AGP version to 8.3.2
          if grep -q "com.android.tools.build:gradle" build.gradle; then
            sed -i "s#com\.android\.tools\.build:gradle:[0-9\.]\+#com.android.tools.build:gradle:8.3.2#g" build.gradle || true
          fi

          # Also check settings.gradle (new Flutter template)
          if [ -f settings.gradle ]; then
            if grep -q "com.android.application" settings.gradle; then
              sed -i "s#id 'com.android.application' version '[0-9\.]\+'#id 'com.android.application' version '8.3.2'#g" settings.gradle || true
            fi
          fi

          # Patch Gradle wrapper to 8.3
          if [ -f gradle/wrapper/gradle-wrapper.properties ]; then
            sed -i "s#distributionUrl=.*#distributionUrl=https\\://services.gradle.org/distributions/gradle-8.3-bin.zip#g" gradle/wrapper/gradle-wrapper.properties || true
          fi

          echo "🔧 Verifying Gradle & AGP versions..."
          grep "com.android.tools.build:gradle" build.gradle || echo "AGP verified"
          grep "distributionUrl" gradle/wrapper/gradle-wrapper.properties || echo "Gradle wrapper verified"

      - name: 🧩 Install Android SDK
        run: |
          echo "Installing Android SDK..."
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools

          # Download command line tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmd.zip
          unzip cmd.zip -d temp
          mv temp/cmdline-tools latest
          rm -rf temp cmd.zip

          # Set environment variables
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH" >> $GITHUB_ENV

          # Accept licenses and install required packages
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-33" \
            "platforms;android-34" \
            "build-tools;33.0.1" \
            "build-tools;34.0.0"

          echo "✅ Android SDK installed successfully."

      - name: ✅ Verify Environment
        run: |
          echo "Checking environment..."
          flutter --version
          java -version
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed

      - name: 🚀 Build Flutter APK (Dev Mode)
        run: |
          echo "Building Flutter debug APK..."
          cd app
          
          # Skip the custom task that requires Windows
          ./gradlew assembleDebug -x updateAppName --no-daemon
          
          # Alternative: Use flutter build with specific flags
          # flutter build apk --debug --no-pub --target-platform android-arm,android-arm64

      - name: 📦 Package build artifacts
        run: |
          echo "Packaging build..."
          cd app/build/app/outputs/apk/debug
          zip -r flutter_build_${{ github.run_id }}.zip .
          mv flutter_build_${{ github.run_id }}.zip $GITHUB_WORKSPACE/
          echo "✅ Build packaged successfully."

      - name: 📤 Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter_build_${{ github.run_id }}
          path: flutter_build_${{ github.run_id }}.zip
          retention-days: 5